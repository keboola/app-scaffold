{
    "operations": [
        {
            "operation": "create.configuration",
            "id": "snowflakeExtractor",
            "KBCComponentId": "keboola.ex-db-snowflake",
            "payload": {
                "name": "Extract sample data",
                "configuration": {
                    "parameters": {
                        "db": {
                            "port": 443,
                            "ssh": {
                                "sshPort": 22
                            }
                        },
                        "tables": [
                            {
                                "enabled": true,
                                "name": "ACCOUNT",
                                "incremental": false,
                                "outputTable": "in.c-keboola-ex-db-snowflake-sample.account",
                                "table": {
                                    "schema": "HELP_TUTORIAL",
                                    "tableName": "ACCOUNT"
                                },
                                "columns": [],
                                "primaryKey": [],
                                "id": 1509
                            },
                            {
                                "enabled": true,
                                "name": "USER",
                                "incremental": false,
                                "outputTable": "in.c-keboola-ex-db-snowflake-sample.user",
                                "table": {
                                    "schema": "HELP_TUTORIAL",
                                    "tableName": "USER"
                                },
                                "columns": [],
                                "primaryKey": [],
                                "id": 85768
                            }
                        ]
                    },
                    "processors": {
                        "after": [
                            {
                                "definition": {
                                    "component": "keboola.processor-add-metadata"
                                },
                                "parameters": {
                                    "tables": [
                                        {
                                            "table": "in_c-keboola-ex-db-snowflake-sample_user.csv.gz",
                                            "metadata": [
                                                {
                                                    "key": "bdm.scaffold.entity.type",
                                                    "value": "user"
                                                }
                                            ]
                                        },
                                        {
                                            "table": "in_c-keboola-ex-db-snowflake-sample_account.csv.gz",
                                            "metadata": [
                                                {
                                                    "key": "bdm.scaffold.entity.type",
                                                    "value": "account"
                                                }
                                            ]
                                        }
                                    ]
                                }
                            }
                        ]
                    }
                }
            }
        },
        {
            "operation": "create.configuration",
            "id": "connectionWriter",
            "KBCComponentId": "keboola.wr-storage",
            "payload": {
                "name": "Write processed tables",
                "configuration": {
                    "parameters": {
                    }
                }
            }
        },
        {
            "operation": "create.configrows",
            "refConfigId": "connectionWriter",
            "rows": [
                {
                    "name": "user-processed",
                    "configuration": {
                        "storage": {
                            "input": {
                                "tables": [
                                    {
                                        "source_search": {
                                            "key": "bdm.scaffold.entity.type",
                                            "value": "user"
                                        },
                                        "changed_since": "",
                                        "destination": "user-processed"
                                    }
                                ]
                            }
                        },
                        "parameters": {
                            "mode": "recreate"
                        }
                    }
                }
            ]
        },
        {
            "operation": "create.configuration",
            "id": "mainTransformation",
            "KBCComponentId": "transformation",
            "payload": {
                "name": "My sample transformation",
                "description": "Scaffold testing",
                "configuration": {
                    "foo": "bar"
                }
            }
        },
        {
            "operation": "create.configrows",
            "refConfigId": "mainTransformation",
            "rows": [
                {
                    "name": "Python Trasnformation",
                    "configuration": {
                        "output": [
                            {
                                "destination": "out.c-my-sample-transformation.output",
                                "source": "output.csv"
                            }
                        ],
                        "queries": [
                            "import csv\n\nwith open('in/tables/input.csv', mode='rt', encoding='utf-8') as in_file, open('out/tables/output.csv', mode='wt', encoding='utf-8') as out_file:\n    lazy_lines = (line.replace('\\0', '') for line in in_file)\n    reader = csv.DictReader(lazy_lines, lineterminator='\\n')\n    writer = csv.DictWriter(out_file, fieldnames=reader.fieldnames, lineterminator='\\n')\n    writer.writeheader()\n\n    for row in reader:\n        row['Name'] = row['Name'] + 'Batman'\n        # do something and write row\n        writer.writerow(row)\n"
                        ],
                        "input": [
                            {
                                "source_search": {
                                    "key": "bdm.scaffold.entity.type",
                                    "value": "account"
                                },
                                "destination": "input.csv",
                                "whereColumn": "",
                                "whereValues": [],
                                "whereOperator": "eq",
                                "columns": []
                            }
                        ],
                        "name": "Python Trasnformation",
                        "packages": [],
                        "requires": [],
                        "backend": "docker",
                        "type": "python",
                        "id": "542245245",
                        "phase": 1,
                        "disabled": false,
                        "description": ""
                    }
                },
                {
                    "name": "SQL Transformation",
                    "description": "Scaffold testing",
                    "configuration": {
                        "output": [],
                        "queries": [
                            "CREATE TABLE \"out\" AS SELECT \"Name\", \"Sales_Market\", \"Global_Market\" FROM \"user\";"
                        ],
                        "input": [
                            {
                                "source_search": {
                                    "key": "bdm.scaffold.entity.type",
                                    "value": "user"
                                },
                                "destination": "user",
                                "datatypes": {
                                    "Id": {
                                        "type": "VARCHAR",
                                        "column": "Id",
                                        "length": "16777216",
                                        "convertEmptyValuesToNull": true
                                    },
                                    "Name": {
                                        "type": "VARCHAR",
                                        "column": "Name",
                                        "length": "16777216",
                                        "convertEmptyValuesToNull": true
                                    },
                                    "Sales_Market": {
                                        "type": "VARCHAR",
                                        "column": "Sales_Market",
                                        "length": "16777216",
                                        "convertEmptyValuesToNull": true
                                    },
                                    "Global_Market": {
                                        "type": "VARCHAR",
                                        "column": "Global_Market",
                                        "length": "16777216",
                                        "convertEmptyValuesToNull": true
                                    }
                                },
                                "whereColumn": "",
                                "whereValues": [],
                                "whereOperator": "eq",
                                "columns": []
                            }
                        ],
                        "name": "SQL Transformation",
                        "packages": [],
                        "requires": [],
                        "backend": "snowflake",
                        "type": "simple",
                        "id": "542256945",
                        "phase": 1,
                        "disabled": false,
                        "description": ""
                    },
                    "changeDescription": "Change Queries in SQL Transformation"
                }                
            ]
        },
        {
            "operation": "create.orchestration",
            "payload": {
                "name": "Main",
                "tasks": [
                    {
                        "component": "keboola.ex-db-snowflake",
                        "refConfigId": "snowflakeExtractor",
                        "action": "run",
                        "timeoutMinutes": null,
                        "active": true,
                        "continueOnFailure": false,
                        "phase": "Extraction"
                    },
                    {
                        "component": "transformation",
                        "refConfigId": "mainTransformation",
                        "action": "run",
                        "timeoutMinutes": null,
                        "active": true,
                        "continueOnFailure": false,
                        "phase": "Transformation"
                    },                    
                    {
                        "component": "keboola.wr-storage",
                        "refConfigId": "connectionWriter",
                        "action": "run",
                        "timeoutMinutes": null,
                        "active": true,
                        "continueOnFailure": false,
                        "phase": "Writing"
                    }
                ]
            }
        }
    ]
}
