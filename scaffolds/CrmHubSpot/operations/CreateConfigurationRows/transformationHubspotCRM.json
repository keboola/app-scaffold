[
    {
        "configuration": {
            "output": [
                {
                    "source": "out_company",
                    "primaryKey": [
                        "company_id"
                    ],
                    "metadata": [
                        {
                            "key": "bdm.scaffold.table.tag",
                            "value": "CrmHubSpot.internal.outCrmCompany"
                        },
                        {
                            "key": "scaffold.id",
                            "value": "CrmHubSpot"
                        }
                    ],
                    "destination": "out.c-crmHubSpot.crmCompany"
                }
            ],
            "queries": [
                "--create output table with companies\n--cast timestamp to date\nCREATE TABLE \"out_company\"\nAS\nSELECT DISTINCT \"companyId\"                          AS \"company_id\",\n                \"name\"                               AS \"company\",\n                \"website\"                            AS \"website\",\n                to_date(\"createdate\") :: VARCHAR(10) AS \"date_created\"\nFROM \"companies\"\nWHERE lower(\"isDeleted\") = 'false';",
                "--fake row to keep referential integrity if child tables are missing existing company ids\nINSERT INTO \"out_company\"\n    (\"company_id\", \"company\", \"website\", \"date_created\")\nVALUES ('0', 'Unknown', '', '');"
            ],
            "input": [
                {
                    "destination": "companies",
                    "datatypes": [],
                    "whereColumn": "",
                    "whereValues": [],
                    "whereOperator": "eq",
                    "columns": [],
                    "loadType": "clone",
                    "source": "in.c-crmHubSpot.hubspotCompanies"
                }
            ],
            "name": "Company",
            "packages": [],
            "requires": [],
            "backend": "snowflake",
            "type": "simple",
            "phase": "2",
            "disabled": false,
            "description": ""
        },
        "description": "",
        "name": "Company"
    },
    {
        "configuration": {
            "output": [
                {
                    "source": "out_employee",
                    "primaryKey": [
                        "employee_id"
                    ],
                    "incremental": true,
                    "deleteWhereColumn": "",
                    "deleteWhereOperator": "eq",
                    "deleteWhereValues": [],
                    "metadata": [
                        {
                            "key": "bdm.scaffold.table.tag",
                            "value": "CrmHubSpot.internal.outCrmEmployee"
                        },
                        {
                            "key": "scaffold.id",
                            "value": "CrmHubSpot"
                        }
                    ],
                    "destination": "out.c-crmHubSpot.crmEmployee"
                }
            ],
            "queries": [
                "--create output table with employees\n--concatenate first and last name to get full name of the employee\nCREATE TABLE \"out_employee\"\nAS\nSELECT \"ownerId\"                        AS \"employee_id\",\n       \"firstName\" || ' ' || \"lastName\" AS \"employee\",\n       \"email\",\n       ''                               AS \"position\"\nFROM \"owners\";",
                "--fake row to keep referential integrity if child tables are missing existing employee ids\nINSERT INTO \"out_employee\"\n    (\"employee_id\", \"employee\", \"email\", \"position\")\nVALUES ('0', 'Unknown', '', '');"
            ],
            "input": [
                {
                    "destination": "owners",
                    "datatypes": [],
                    "whereColumn": "",
                    "whereValues": [],
                    "whereOperator": "eq",
                    "columns": [],
                    "loadType": "clone",
                    "source": "in.c-crmHubSpot.hubspotOwners"
                }
            ],
            "name": "Employee",
            "packages": [],
            "requires": [],
            "backend": "snowflake",
            "type": "simple",
            "phase": "2",
            "disabled": false,
            "description": ""
        },
        "description": "",
        "name": "Employee"
    },
    {
        "configuration": {
            "output": [
                {
                    "primaryKey": [
                        "contact_id"
                    ],
                    "source": "out_contact",
                    "metadata": [
                        {
                            "key": "bdm.scaffold.table.tag",
                            "value": "CrmHubSpot.internal.outCrmContact"
                        },
                        {
                            "key": "scaffold.id",
                            "value": "CrmHubSpot"
                        }
                    ],
                    "destination": "out.c-crmHubSpot.crmContact"
                }
            ],
            "queries": [
                "--create output table with leads and contacts\n--concatenate first and last name to get full name\n--leads are identified as contacts\/converted if they have and associatedcompanyid filled\nCREATE TABLE \"out_contact\"\nAS\nSELECT \"canonical_vid\" || '_contact'                                    AS \"contact_id\",\n       \"firstname\" || ' ' || \"lastname\"                                 AS \"contact\",\n       \"email\"                                                          AS \"email\",\n       'Contact'                                                        AS \"contact_type\",\n       iff(\"createdate\" = '', '', to_date(\"createdate\") :: VARCHAR(10)) AS \"date_created\",\n       \"email_source\"                                                   AS \"lead_source\",\n       'Is Contact'                                                     AS \"lead_converted\"\nFROM \"contacts\"\nWHERE \"associatedcompanyid\" != ''\nUNION ALL\n--insert leads and mark if they are already converted (\"associatedcompanyid\" != '')\nSELECT \"canonical_vid\" || '_lead'                                       AS \"contact_id\",\n       \"firstname\" || ' ' || \"lastname\"                                 AS \"contact\",\n       \"email\"                                                          AS \"email\",\n       'Lead'                                                           AS \"contact_type\",\n       iff(\"createdate\" = '', '', to_date(\"createdate\") :: VARCHAR(10)) AS \"date_created\",\n       \"email_source\"                                                   AS \"lead_source\",\n       iff(\"associatedcompanyid\" != '', 'Yes', 'No')                    AS \"lead_converted\"\nFROM \"contacts\";",
                "--fake row to keep referential integrity if child tables are missing existing contact ids\nINSERT INTO \"out_contact\"\n(\"contact_id\", \"contact\", \"email\", \"contact_type\", \"date_created\", \"lead_source\", \"lead_converted\")\nVALUES ('0', 'Unknown', '', 'Lead', '', '', 'No');"
            ],
            "input": [
                {
                    "destination": "contacts",
                    "datatypes": [],
                    "whereColumn": "",
                    "whereValues": [],
                    "whereOperator": "eq",
                    "columns": [],
                    "loadType": "clone",
                    "source": "in.c-crmHubSpot.hubspotContacts"
                }
            ],
            "name": "Contact",
            "packages": [],
            "requires": [],
            "backend": "snowflake",
            "type": "simple",
            "phase": "2",
            "disabled": false,
            "description": ""
        },
        "description": "",
        "name": "Contact"
    },
    {
        "configuration": {
            "output": [
                {
                    "source": "out_opportunity",
                    "primaryKey": [
                        "opportunity_id"
                    ],
                    "metadata": [
                        {
                            "key": "bdm.scaffold.table.tag",
                            "value": "CrmHubSpot.internal.outCrmOpportunity"
                        },
                        {
                            "key": "scaffold.id",
                            "value": "CrmHubSpot"
                        }
                    ],
                    "destination": "out.c-crmHubSpot.crmOpportunity"
                },
                {
                    "source": "out_opportunity_snapshot",
                    "primaryKey": [
                        "snapshot_date",
                        "opportunity_id"
                    ],
                    "incremental": true,
                    "deleteWhereColumn": "",
                    "deleteWhereOperator": "eq",
                    "deleteWhereValues": [],
                    "metadata": [
                        {
                            "key": "bdm.scaffold.table.tag",
                            "value": "CrmHubSpot.internal.outCrmAuxiliaryTablesOpportunitySnapshot"
                        },
                        {
                            "key": "scaffold.id",
                            "value": "CrmHubSpot"
                        }
                    ],
                    "destination": "out.c-crmHubSpot.crmAuxiliaryTablesOpportunitySnapshot"
                }
            ],
            "queries": [
                "--create output table with opportunities\n--cast timestamps to human-readable date format\n--if there is no amount set, place 0 instead of empty value\n--opportunities with stage label 'closed won' are marked as won\n--check referential integrity with employees and companies\nCREATE TABLE \"out_opportunity\"\nAS\n    SELECT\n        \"d\".\"dealId\"                                                             AS \"opportunity_id\",\n        coalesce(\"c\".\"company_id\", '0')                                          AS \"company_id\",\n        coalesce(\"e\".\"employee_id\", '0')                                         AS \"employee_id\",\n        \"d\".\"dealname\"                                                           AS \"opportunity\",\n        iff(\"d\".\"createdate\" = '', '', to_date(\"d\".\"createdate\") :: VARCHAR(10)) AS \"date_created\",\n        iff(\"d\".\"closedate\" = '', '', to_date(\"d\".\"closedate\") :: VARCHAR(10))   AS \"date_closed\",\n        iff(\"d\".\"closedate\" = '', 'No', 'Yes')                                   AS \"is_closed\",\n        iff(\"s\".\"closedWon\" = 'True', 'Yes', 'No')                               AS \"is_won\",\n        \"p\".\"label\"                                                              AS \"pipeline\",\n        \"s\".\"label\"                                                              AS \"stage\",\n        \"s\".\"displayOrder\"                                                       AS \"stage_order\",\n        \"d\".\"dealtype\"                                                           AS \"opportunity_type\",\n        iff(\"d\".\"amount\" = '', '0', \"d\".\"amount\")                                AS \"opportunity_value\",\n        ''                                                                       AS \"currency\",\n        \"d\".\"hs_analytics_source\"                                                AS \"lead_source\",\n        \"s\".\"probability\"\t\t\t                                             AS \"probability\"\n    FROM \"deals\" \"d\"\n             LEFT JOIN \"pipelines\" \"p\"\n                       ON \"d\".\"pipeline\" = \"p\".\"pipelineId\"\n             LEFT JOIN \"stages\" \"s\"\n                       ON \"d\".\"dealstage\" = \"s\".\"stageId\"\n             LEFT JOIN \"employee_ri\" \"e\"\n                       ON \"d\".\"hubspot_owner_id\" = \"e\".\"employee_id\"\n             LEFT JOIN \"deals_companies\" \"dc\"\n                       ON \"d\".\"dealId\" = \"dc\".\"dealId\"\n             LEFT JOIN \"company_ri\" \"c\"\n                       ON \"dc\".\"associated_companyId\" = \"c\".\"company_id\"\n    WHERE lower(\"d\".\"isDeleted\") = 'false';",
                "--set timezone to UTC (!!!CHANGE ACCORDINGLY TO YOUR REGION!!!)\nALTER\n    SESSION\n    SET TIMEZONE = 'UTC';",
                "--create snapshot of the output table to track changes throughout time\n--snapshot will be used in another transformation where it will be adjusted for a better final analysis\nCREATE TABLE \"out_opportunity_snapshot\"\nAS\n    SELECT\n        current_date AS \"snapshot_date\",\n        \"o\".*\n    FROM \"out_opportunity\" \"o\";",
                "--fake row to keep referential integrity if child tables are missing existing opportunity ids\n--adding row after snapshot, so we're not unnecessary snapshoting it\nINSERT INTO \"out_opportunity\"\n    (\"opportunity_id\", \"company_id\", \"employee_id\", \"opportunity\", \"date_created\", \"date_closed\", \"is_closed\", \"is_won\",\n     \"pipeline\", \"stage\", \"opportunity_type\", \"opportunity_value\", \"currency\", \"lead_source\")\nVALUES\n    ('0', '0', '0', 'Unknown', '', '', 'No', 'No', '', '', '', '0.0', '', '');"
            ],
            "input": [
                {
                    "destination": "employee_ri",
                    "datatypes": [],
                    "whereColumn": "",
                    "whereValues": [],
                    "whereOperator": "eq",
                    "columns": [],
                    "loadType": "clone",
                    "source": "out.c-crmHubSpot.crmEmployee"
                },
                {
                    "destination": "company_ri",
                    "datatypes": [],
                    "whereColumn": "",
                    "whereValues": [],
                    "whereOperator": "eq",
                    "columns": [],
                    "loadType": "clone",
                    "source": "out.c-crmHubSpot.crmCompany"
                },
                {
                    "destination": "deals",
                    "datatypes": [],
                    "whereColumn": "",
                    "whereValues": [],
                    "whereOperator": "eq",
                    "columns": [],
                    "loadType": "clone",
                    "source": "in.c-crmHubSpot.hubspotDeals"
                },
                {
                    "destination": "stages",
                    "datatypes": [],
                    "whereColumn": "",
                    "whereValues": [],
                    "whereOperator": "eq",
                    "columns": [],
                    "loadType": "clone",
                    "source": "in.c-crmHubSpot.hubspotStages"
                },
                {
                    "destination": "pipelines",
                    "datatypes": [],
                    "whereColumn": "",
                    "whereValues": [],
                    "whereOperator": "eq",
                    "columns": [],
                    "loadType": "clone",
                    "source": "in.c-crmHubSpot.hubspotPipelines"
                },
                {
                    "destination": "deals_companies",
                    "datatypes": [],
                    "whereColumn": "",
                    "whereValues": [],
                    "whereOperator": "eq",
                    "columns": [],
                    "loadType": "clone",
                    "source": "in.c-crmHubSpot.hubspotDealsCompanies"
                }
            ],
            "name": "Opportunity & Auxiliary Snapshot",
            "packages": [],
            "requires": [],
            "backend": "snowflake",
            "type": "simple",
            "phase": "3",
            "disabled": false,
            "description": ""
        },
        "description": "",
        "name": "Opportunity & Auxiliary Snapshot"
    },
    {
        "configuration": {
            "output": [
                {
                    "source": "out_opportunity_contact",
                    "primaryKey": [
                        "opportunity_contact_id"
                    ],
                    "metadata": [
                        {
                            "key": "bdm.scaffold.table.tag",
                            "value": "CrmHubSpot.internal.outCrmOpportunityContact"
                        },
                        {
                            "key": "scaffold.id",
                            "value": "CrmHubSpot"
                        }
                    ],
                    "destination": "out.c-crmHubSpot.crmOpportunityContact"
                }
            ],
            "queries": [
                "--create output paring table for opportunities and contacts\n--merge both tables ids as paring table id\n--use inner joins and ids from referring tables to make sure referential integrity is intact\nCREATE TABLE \"out_opportunity_contact\"\nAS\nSELECT \"o\".\"opportunity_id\" || '-' || \"c\".\"contact_id\" AS \"opportunity_contact_id\",\n       \"o\".\"opportunity_id\",\n       \"c\".\"contact_id\",\n       ''                                              AS \"is_primary_contact\",\n       ''                                              AS \"role\"\nFROM \"deals_contacts_list\" \"dc\"\n         INNER JOIN \"opportunity_ri\" \"o\"\n                    ON \"dc\".\"dealId\" = \"o\".\"opportunity_id\"\n         INNER JOIN \"contact_ri\" \"c\"\n                    ON \"dc\".\"contact_vid\" || '_contact' = \"c\".\"contact_id\";"
            ],
            "input": [
                {
                    "destination": "contact_ri",
                    "datatypes": [],
                    "whereColumn": "",
                    "whereValues": [],
                    "whereOperator": "eq",
                    "columns": [],
                    "loadType": "clone",
                    "source": "out.c-crmHubSpot.crmContact"
                },
                {
                    "destination": "opportunity_ri",
                    "datatypes": [],
                    "whereColumn": "",
                    "whereValues": [],
                    "whereOperator": "eq",
                    "columns": [],
                    "loadType": "clone",
                    "source": "out.c-crmHubSpot.crmOpportunity"
                },
                {
                    "destination": "deals_contacts_list",
                    "datatypes": [],
                    "whereColumn": "",
                    "whereValues": [],
                    "whereOperator": "eq",
                    "columns": [],
                    "loadType": "clone",
                    "source": "in.c-crmHubSpot.hubspotDealsContactsList"
                }
            ],
            "name": "Opportunity Contact",
            "packages": [],
            "requires": [],
            "backend": "snowflake",
            "type": "simple",
            "phase": "4",
            "disabled": false,
            "description": ""
        },
        "description": "",
        "name": "Opportunity Contact"
    },
    {
        "configuration": {
            "output": [
                {
                    "primaryKey": [
                        "opportunity_id",
                        "snapshot_date"
                    ],
                    "source": "out_opportunity_snapshot",
                    "incremental": true,
                    "deleteWhereColumn": "",
                    "deleteWhereOperator": "eq",
                    "deleteWhereValues": [],
                    "metadata": [
                        {
                            "key": "bdm.scaffold.table.tag",
                            "value": "CrmHubSpot.internal.outCrmOpportunitySnapshot"
                        },
                        {
                            "key": "scaffold.id",
                            "value": "CrmHubSpot"
                        }
                    ],
                    "destination": "out.c-crmHubSpot.crmOpportunitySnapshot"
                }
            ],
            "queries": [
                "--create temporary table for additional calculations\n--add previous values of pipeline, stage and value, so we can define if there has been any change\nCREATE TABLE \"opportunity_snapshot_tmp\"\nAS\n    SELECT\n        \"opportunity_id\",\n        \"snapshot_date\",\n        \"employee_id\",\n        \"company_id\",\n        \"pipeline\",\n        ifnull(lag(\"pipeline\") OVER (PARTITION BY \"opportunity_id\" ORDER BY \"snapshot_date\"),\n               \"pipeline\")          AS \"previous_pipeline\",\n        \"stage\",\n        \"stage_order\",\n        ifnull(lag(\"stage\") OVER (PARTITION BY \"opportunity_id\" ORDER BY \"snapshot_date\"),\n               \"stage\")             AS \"previous_stage\",\n        ifnull(lag(\"stage_order\") OVER (PARTITION BY \"opportunity_id\" ORDER BY \"snapshot_date\"),\n               \"stage_order\")       AS \"previous_stage_order\",\n        \"opportunity_value\",\n        ifnull(lag(\"opportunity_value\") OVER (PARTITION BY \"opportunity_id\" ORDER BY \"snapshot_date\"),\n               \"opportunity_value\") AS \"previous_opportunity_value\",\n        \"probability\",\n        ifnull(lag(\"probability\") OVER (PARTITION BY \"opportunity_id\" ORDER BY \"snapshot_date\"),\n               \"probability\")       AS \"previous_probability\"\n    FROM \"opportunity_snapshot\";",
                "--create opportunity snapshot table\n--define if there has been change of pipeline, stage or value\nCREATE TABLE \"out_opportunity_snapshot\"\nAS\n    SELECT\n        \"s\".\"opportunity_id\",\n        \"s\".\"snapshot_date\",\n        \"s\".\"employee_id\",\n        \"s\".\"company_id\",\n        \"s\".\"pipeline\",\n        \"s\".\"previous_pipeline\",\n        iff(\"s\".\"pipeline\" <> \"s\".\"previous_pipeline\", 'Yes', 'No')                   AS \"pipeline_change\",\n        \"s\".\"stage\",\n        \"s\".\"stage_order\",\n        \"s\".\"previous_stage\",\n        \"s\".\"previous_stage_order\",\n        iff(\"s\".\"stage\" <> \"s\".\"previous_stage\", 'Yes', 'No')                         AS \"stage_change\",\n        \"s\".\"opportunity_value\",\n        \"s\".\"previous_opportunity_value\",\n        iff(\"s\".\"opportunity_value\" <> \"s\".\"previous_opportunity_value\", 'Yes', 'No') AS \"opportunity_value_change\",\n        \"s\".\"probability\",\n        \"s\".\"previous_probability\",\n        iff(\"s\".\"probability\" <> \"s\".\"previous_probability\", 'Yes', 'No')             AS \"probability_change\",\n        iff(\"m\".\"max_date_in_month\" IS NULL, 'false', 'true')                         AS \"max_date_in_month\"\n    FROM \"opportunity_snapshot_tmp\" \"s\"\n             LEFT JOIN (SELECT\n                            \"opportunity_id\",\n                            left(\"snapshot_date\", 7) AS \"month\",\n                            max(\"snapshot_date\")     AS \"max_date_in_month\"\n                        FROM \"opportunity_snapshot_tmp\"\n                        GROUP BY 1, 2) \"m\"\n                       ON \"s\".\"opportunity_id\" = \"m\".\"opportunity_id\"\n                           AND \"s\".\"snapshot_date\" = \"m\".\"max_date_in_month\";"
            ],
            "input": [
                {
                    "destination": "opportunity_snapshot",
                    "datatypes": [],
                    "whereColumn": "",
                    "whereValues": [],
                    "whereOperator": "eq",
                    "columns": [],
                    "loadType": "clone",
                    "source": "out.c-crmHubSpot.crmAuxiliaryTablesOpportunitySnapshot"
                }
            ],
            "name": "Opportunity Snapshot",
            "packages": [],
            "requires": [],
            "backend": "snowflake",
            "type": "simple",
            "phase": "4",
            "disabled": false,
            "description": ""
        },
        "description": "",
        "name": "Opportunity Snapshot"
    },
    {
        "configuration": {
            "output": [
                {
                    "source": "out_companies",
                    "primaryKey": [
                        "companyId"
                    ],
                    "metadata": [
                        {
                            "key": "bdm.scaffold.table.tag",
                            "value": "CrmHubSpot.internal.inHubspotCompanies"
                        },
                        {
                            "key": "scaffold.id",
                            "value": "CrmHubSpot"
                        }
                    ],
                    "destination": "in.c-crmHubSpot.hubspotCompanies"
                },
                {
                    "source": "out_contacts",
                    "primaryKey": [
                        "canonical_vid"
                    ],
                    "metadata": [
                        {
                            "key": "bdm.scaffold.table.tag",
                            "value": "CrmHubSpot.internal.inHubspotContacts"
                        },
                        {
                            "key": "scaffold.id",
                            "value": "CrmHubSpot"
                        }
                    ],
                    "destination": "in.c-crmHubSpot.hubspotContacts"
                },
                {
                    "source": "out_owners",
                    "primaryKey": [
                        "ownerId"
                    ],
                    "metadata": [
                        {
                            "key": "bdm.scaffold.table.tag",
                            "value": "CrmHubSpot.internal.inHubspotOwners"
                        },
                        {
                            "key": "scaffold.id",
                            "value": "CrmHubSpot"
                        }
                    ],
                    "destination": "in.c-crmHubSpot.hubspotOwners"
                },
                {
                    "source": "out_deals",
                    "primaryKey": [
                        "dealId"
                    ],
                    "metadata": [
                        {
                            "key": "bdm.scaffold.table.tag",
                            "value": "CrmHubSpot.internal.inHubspotDeals"
                        },
                        {
                            "key": "scaffold.id",
                            "value": "CrmHubSpot"
                        }
                    ],
                    "destination": "in.c-crmHubSpot.hubspotDeals"
                },
                {
                    "source": "out_pipelines",
                    "primaryKey": [
                        "pipelineId"
                    ],
                    "metadata": [
                        {
                            "key": "bdm.scaffold.table.tag",
                            "value": "CrmHubSpot.internal.inHubspotPipelines"
                        },
                        {
                            "key": "scaffold.id",
                            "value": "CrmHubSpot"
                        }
                    ],
                    "destination": "in.c-crmHubSpot.hubspotPipelines"
                },
                {
                    "source": "out_stages",
                    "primaryKey": [
                        "stageId"
                    ],
                    "metadata": [
                        {
                            "key": "bdm.scaffold.table.tag",
                            "value": "CrmHubSpot.internal.inHubspotStages"
                        },
                        {
                            "key": "scaffold.id",
                            "value": "CrmHubSpot"
                        }
                    ],
                    "destination": "in.c-crmHubSpot.hubspotStages"
                },
                {
                    "source": "out_deals_contacts_list",
                    "primaryKey": [
                        "contact_vid",
                        "dealId"
                    ],
                    "metadata": [
                        {
                            "key": "bdm.scaffold.table.tag",
                            "value": "CrmHubSpot.internal.inHubspotDealsContactsList"
                        },
                        {
                            "key": "scaffold.id",
                            "value": "CrmHubSpot"
                        }
                    ],
                    "destination": "in.c-crmHubSpot.hubspotDealsContactsList"
                },
                {
                    "source": "out_activities",
                    "primaryKey": [
                        "engagement_id"
                    ],
                    "metadata": [
                        {
                            "key": "bdm.scaffold.table.tag",
                            "value": "CrmHubSpot.internal.inHubspotActivities"
                        },
                        {
                            "key": "scaffold.id",
                            "value": "CrmHubSpot"
                        }
                    ],
                    "destination": "in.c-crmHubSpot.hubspotActivities"
                },
                {
                    "source": "out_deals_companies",
                    "primaryKey": [
                        "associated_companyId",
                        "dealId"
                    ],
                    "metadata": [
                        {
                            "key": "bdm.scaffold.table.tag",
                            "value": "CrmHubSpot.internal.inHubspotDealsCompanies"
                        },
                        {
                            "key": "scaffold.id",
                            "value": "CrmHubSpot"
                        }
                    ],
                    "destination": "in.c-crmHubSpot.hubspotDealsCompanies"
                }
            ],
            "queries": [
                "--account table\nCREATE TABLE \"companies_tmp\"\nAS\n    SELECT\n        OBJECT_CONSTRUCT(*) AS \"obj\"\n    FROM \"companies\";",
                "CREATE TABLE \"out_companies\"\nAS\n    SELECT\n        trim(\"obj\":\"companyId\", '\"')  AS \"companyId\",\n        trim(\"obj\":\"name\", '\"')       AS \"name\",\n        trim(\"obj\":\"website\", '\"')    AS \"website\",\n        trim(\"obj\":\"createdate\", '\"') AS \"createdate\",\n        trim(\"obj\":\"isDeleted\", '\"')  AS \"isDeleted\"\n    FROM \"companies_tmp\";",
                "--contacts table\nCREATE TABLE \"contacts_tmp\"\nAS\n    SELECT\n        OBJECT_CONSTRUCT(*) AS \"obj\"\n    FROM \"contacts\";",
                "CREATE TABLE \"out_contacts\"\nAS\n    SELECT\n        trim(\"obj\":\"canonical_vid\", '\"')       AS \"canonical_vid\",\n        trim(\"obj\":\"firstname\", '\"')           AS \"firstname\",\n        trim(\"obj\":\"lastname\", '\"')            AS \"lastname\",\n        trim(\"obj\":\"email\", '\"')               AS \"email\",\n        trim(\"obj\":\"createdate\", '\"')          AS \"createdate\",\n        trim(\"obj\":\"email_source\", '\"')        AS \"email_source\",\n        trim(\"obj\":\"associatedcompanyid\", '\"') AS \"associatedcompanyid\",\n        trim(\"obj\":\"lifecyclestage\", '\"')      AS \"lifecyclestage\"\n    FROM \"contacts_tmp\";",
                "--owners table\nCREATE TABLE \"owners_tmp\"\nAS\n    SELECT\n        OBJECT_CONSTRUCT(*) AS \"obj\"\n    FROM \"owners\";",
                "CREATE TABLE \"out_owners\"\nAS\n    SELECT\n        trim(\"obj\":\"ownerId\", '\"')   AS \"ownerId\",\n        trim(\"obj\":\"firstName\", '\"') AS \"firstName\",\n        trim(\"obj\":\"lastName\", '\"')  AS \"lastName\",\n        trim(\"obj\":\"email\", '\"')     AS \"email\"\n    FROM \"owners_tmp\";",
                "--deals table\nCREATE TABLE \"deals_tmp\"\nAS\n    SELECT\n        OBJECT_CONSTRUCT(*) AS \"obj\"\n    FROM \"deals\";",
                "CREATE TABLE \"out_deals\"\nAS\n    SELECT\n        trim(\"obj\":\"dealId\", '\"')               AS \"dealId\",\n        trim(\"obj\":\"isDeleted\", '\"')            AS \"isDeleted\",\n        trim(\"obj\":\"dealname\", '\"')             AS \"dealname\",\n        trim(\"obj\":\"createdate\", '\"')           AS \"createdate\",\n        trim(\"obj\":\"closedate\", '\"')            AS \"closedate\",\n        trim(\"obj\":\"dealtype\", '\"')             AS \"dealtype\",\n        trim(\"obj\":\"amount\", '\"')               AS \"amount\",\n        trim(\"obj\":\"pipeline\", '\"')             AS \"pipeline\",\n        trim(\"obj\":\"dealstage\", '\"')            AS \"dealstage\",\n        trim(\"obj\":\"hubspot_owner_id\", '\"')     AS \"hubspot_owner_id\",\n        trim(\"obj\":\"hs_analytics_source\", '\"')  AS \"hs_analytics_source\"\n    FROM \"deals_tmp\";",
                "--deals companies table\nCREATE TABLE \"deals_companies_tmp\"\nAS\n    SELECT\n        OBJECT_CONSTRUCT(*) AS \"obj\"\n    FROM \"deals_companies\";",
                "CREATE TABLE \"out_deals_companies\"\nAS\n    SELECT\n        trim(\"obj\":\"dealId\", '\"')               AS \"dealId\",\n        trim(\"obj\":\"associated_companyId\", '\"') AS \"associated_companyId\"\n    FROM \"deals_companies_tmp\";",
                "--pipelines table\nCREATE TABLE \"pipelines_tmp\"\nAS\n    SELECT\n        OBJECT_CONSTRUCT(*) AS \"obj\"\n    FROM \"pipelines\";",
                "CREATE TABLE \"out_pipelines\"\nAS\n    SELECT\n        trim(\"obj\":\"pipelineId\", '\"') AS \"pipelineId\",\n        trim(\"obj\":\"label\", '\"')      AS \"label\"\n    FROM \"pipelines_tmp\";",
                "--stages table\nCREATE TABLE \"stages_tmp\"\nAS\n    SELECT\n        OBJECT_CONSTRUCT(*) AS \"obj\"\n    FROM \"pipeline_stages\";",
                "CREATE TABLE \"out_stages\"\nAS\n    SELECT\n        trim(\"obj\":\"stageId\", '\"') \t\tAS \"stageId\",\n        trim(\"obj\":\"label\", '\"')   \t\tAS \"label\",\n        trim(\"obj\":\"displayOrder\", '\"') AS \"displayOrder\",\n        trim(\"obj\":\"probability\", '\"')\tAS \"probability\",\n        trim(\"obj\":\"closedWon\", '\"')\tAS \"closedWon\"\n    FROM \"stages_tmp\";",
                "--deals_contacts_list table\nCREATE TABLE \"deals_contacts_list_tmp\"\nAS\n    SELECT\n        OBJECT_CONSTRUCT(*) AS \"obj\"\n    FROM \"deals_contacts_list\";",
                "CREATE TABLE \"out_deals_contacts_list\"\nAS\n    SELECT\n        trim(\"obj\":\"contact_vid\", '\"') AS \"contact_vid\",\n        trim(\"obj\":\"dealId\", '\"')      AS \"dealId\"\n    FROM \"deals_contacts_list_tmp\";",
                "--activities table\nCREATE TABLE \"activities_tmp\"\nAS\n    SELECT\n        OBJECT_CONSTRUCT(*) AS \"obj\"\n    FROM \"activities\";",
                "CREATE TABLE \"out_activities\"\nAS\n    SELECT\n        trim(\"obj\":\"engagement_id\", '\"')                 AS \"engagement_id\",\n        trim(\"obj\":\"metadata_subject\", '\"')              AS \"metadata_subject\",\n        trim(\"obj\":\"engagement_createdAt\", '\"')          AS \"engagement_createdAt\",\n        trim(\"obj\":\"metadata_durationMilliseconds\", '\"') AS \"metadata_durationMilliseconds\",\n        trim(\"obj\":\"associations_contactIds\", '\"')       AS \"associations_contactIds\",\n        trim(\"obj\":\"associations_dealIds\", '\"')          AS \"associations_dealIds\",\n        trim(\"obj\":\"associations_ownerIds\", '\"')         AS \"associations_ownerIds\"\n\n    FROM \"activities_tmp\";"
            ],
            "input": [
                {
                    "destination": "companies",
                    "datatypes": [],
                    "whereColumn": "",
                    "whereValues": [],
                    "whereOperator": "eq",
                    "columns": [],
                    "loadType": "clone",
                    "source_search": {
                        "key": "bdm.scaffold.table.tag",
                        "value": "CrmHubSpot.internal.inKdsTeamExHubspotCrmCompanies"
                    }
                },
                {
                    "destination": "contacts",
                    "datatypes": [],
                    "whereColumn": "",
                    "whereValues": [],
                    "whereOperator": "eq",
                    "columns": [],
                    "loadType": "clone",
                    "source_search": {
                        "key": "bdm.scaffold.table.tag",
                        "value": "CrmHubSpot.internal.inKdsTeamExHubspotCrmContacts"
                    }
                },
                {
                    "destination": "owners",
                    "datatypes": [],
                    "whereColumn": "",
                    "whereValues": [],
                    "whereOperator": "eq",
                    "columns": [],
                    "loadType": "clone",
                    "source_search": {
                        "key": "bdm.scaffold.table.tag",
                        "value": "CrmHubSpot.internal.inKdsTeamExHubspotCrmOwners"
                    }
                },
                {
                    "destination": "deals",
                    "datatypes": [],
                    "whereColumn": "",
                    "whereValues": [],
                    "whereOperator": "eq",
                    "columns": [],
                    "loadType": "clone",
                    "source_search": {
                        "key": "bdm.scaffold.table.tag",
                        "value": "CrmHubSpot.internal.inKdsTeamExHubspotCrmDeals"
                    }
                },
                {
                    "destination": "pipelines",
                    "datatypes": [],
                    "whereColumn": "",
                    "whereValues": [],
                    "whereOperator": "eq",
                    "columns": [],
                    "loadType": "clone",
                    "source_search": {
                        "key": "bdm.scaffold.table.tag",
                        "value": "CrmHubSpot.internal.inKdsTeamExHubspotCrmPipelines"
                    }
                },
                {
                    "destination": "deals_contacts_list",
                    "datatypes": [],
                    "whereColumn": "",
                    "whereValues": [],
                    "whereOperator": "eq",
                    "columns": [],
                    "loadType": "clone",
                    "source_search": {
                        "key": "bdm.scaffold.table.tag",
                        "value": "CrmHubSpot.internal.inKdsTeamExHubspotCrmDealsContactsList"
                    }
                },
                {
                    "destination": "pipeline_stages",
                    "datatypes": [],
                    "whereColumn": "",
                    "whereValues": [],
                    "whereOperator": "eq",
                    "columns": [],
                    "loadType": "clone",
                    "source_search": {
                        "key": "bdm.scaffold.table.tag",
                        "value": "CrmHubSpot.internal.inKdsTeamExHubspotCrmPipelineStages"
                    }
                },
                {
                    "destination": "activities",
                    "datatypes": [],
                    "whereColumn": "",
                    "whereValues": [],
                    "whereOperator": "eq",
                    "columns": [],
                    "loadType": "clone",
                    "source_search": {
                        "key": "bdm.scaffold.table.tag",
                        "value": "CrmHubSpot.internal.inKdsTeamExHubspotCrmActivities"
                    }
                },
                {
                    "destination": "deals_companies",
                    "datatypes": [],
                    "whereColumn": "",
                    "whereValues": [],
                    "whereOperator": "eq",
                    "columns": [],
                    "loadType": "clone",
                    "source_search": {
                        "key": "bdm.scaffold.table.tag",
                        "value": "CrmHubSpot.internal.inKdsTeamExHubspotCrmDealsAssocCompaniesList"
                    }
                }
            ],
            "name": "Input Tables Creation",
            "packages": [],
            "requires": [],
            "backend": "snowflake",
            "type": "simple",
            "phase": 1,
            "disabled": false,
            "description": ""
        },
        "description": "This Transformation checks for missing columns needed in the following Transformations, adding them to the output tables a populating them with NULL values if missing.",
        "name": "Input Tables Creation"
    },
    {
        "configuration": {
            "output": [
                {
                    "source": "out_activity",
                    "primaryKey": [
                        "activity_id"
                    ],
                    "metadata": [
                        {
                            "key": "bdm.scaffold.table.tag",
                            "value": "CrmHubSpot.internal.outCrmActivity"
                        },
                        {
                            "key": "scaffold.id",
                            "value": "CrmHubSpot"
                        }
                    ],
                    "destination": "out.c-crmHubSpot.crmActivity"
                }
            ],
            "queries": [
                "--create output activity table\n--use only activity related to either contact\/lead or opportunity\n--format datetime\n--convert duration to minutes\n--using the first contact\/opportunity\/employee ID in array from activities table for joins\nCREATE OR REPLACE TABLE \"out_activity\"\nAS\nSELECT \"a\".\"engagement_id\"                              AS \"activity_id\",\n       ifnull(\"e\".\"employee_id\", '0')                   AS \"employee_id\",\n       ifnull(\"c\".\"contact_id\", '0')                    AS \"contact_id\",\n       ifnull(\"o\".\"opportunity_id\", '0')                AS \"opportunity_id\",\n       iff(length(\"a\".\"metadata_subject\") > 1028, left(\"a\".\"metadata_subject\", 1025) || '...', \"a\".\"metadata_subject\")\t\t                          AS \"activity\",\n       TO_CHAR(TO_TIMESTAMP_NTZ(\"a\".\"engagement_createdAt\"),\n               'YYYY-MM-DD hh24:mi:ss')                 AS \"activity_date\",\n       iff(\"a\".\"metadata_durationMilliseconds\" = '', NULL,\n           \"a\".\"metadata_durationMilliseconds\" \/ 60000) AS \"activity_duration_m\"\nFROM \"activities\" \"a\"\n         LEFT JOIN \"contact\" \"c\"\n                   ON SPLIT_PART(REPLACE(REPLACE(\"a\".\"associations_contactIds\", ']', ''), '[', ''), ',', 0) ||\n                      '_contact' = \"c\".\"contact_id\"\n         LEFT JOIN \"opportunity\" \"o\"\n                   ON SPLIT_PART(REPLACE(REPLACE(\"a\".\"associations_dealIds\", ']', ''), '[', ''), ',', 0) =\n                      \"o\".\"opportunity_id\"\n         LEFT JOIN \"employee\" \"e\"\n                   ON SPLIT_PART(REPLACE(REPLACE(\"a\".\"associations_ownerIds\", ']', ''), '[', ''), ',', 0) =\n                      \"e\".\"employee_id\"\nWHERE (\"c\".\"contact_id\" IS NOT NULL OR \"o\".\"opportunity_id\" IS NOT NULL)\n;"
            ],
            "input": [
                {
                    "destination": "activities",
                    "datatypes": [],
                    "whereColumn": "",
                    "whereValues": [],
                    "whereOperator": "eq",
                    "columns": [],
                    "loadType": "clone",
                    "source": "in.c-crmHubSpot.hubspotActivities"
                },
                {
                    "destination": "opportunity",
                    "datatypes": [],
                    "whereColumn": "",
                    "whereValues": [],
                    "whereOperator": "eq",
                    "columns": [],
                    "loadType": "clone",
                    "source": "out.c-crmHubSpot.crmOpportunity"
                },
                {
                    "destination": "contact",
                    "datatypes": [],
                    "whereColumn": "",
                    "whereValues": [],
                    "whereOperator": "eq",
                    "columns": [],
                    "loadType": "clone",
                    "source": "out.c-crmHubSpot.crmContact"
                },
                {
                    "destination": "employee",
                    "datatypes": [],
                    "whereColumn": "",
                    "whereValues": [],
                    "whereOperator": "eq",
                    "columns": [],
                    "loadType": "clone",
                    "source": "out.c-crmHubSpot.crmEmployee"
                }
            ],
            "name": "Activities",
            "packages": [],
            "requires": [],
            "backend": "snowflake",
            "type": "simple",
            "phase": "4",
            "disabled": false,
            "description": ""
        },
        "description": "",
        "name": "Activities"
    }
]
